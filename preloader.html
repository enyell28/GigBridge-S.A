<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema Avanzado de Gestión Financiera Empresarial</title>
<style>
  :root{ --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#3b82f6; --success:#10b981; --danger:#ef4444; --glass: rgba(255,255,255,0.03); --warning:#f59e0b; --purple:#8b5cf6;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071028 0%, #071b2a 100%);color:#e6eef6;padding:28px}
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  h2{font-size:18px;margin:0 0 12px 0}
  h3{font-size:16px;margin:0 0 10px 0}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:14px;color:#eaf5ff;box-shadow:0 4px 18px rgba(2,6,23,0.6)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input,select,button,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-family:inherit}
  textarea{min-height:80px;resize:vertical}
  .small{padding:6px 8px;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:var(--muted);font-weight:600}
  tfoot td{font-weight:700}
  .positive{color:var(--success)}
  .negative{color:var(--danger)}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;transition:opacity 0.2s}
  .btn:hover{opacity:0.8}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .btn.success{background:var(--success)}
  .btn.warning{background:var(--warning)}
  .btn.danger{background:var(--danger)}
  .small-btn{padding:6px 8px;font-size:13px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .controls{display:flex;gap:8px;margin-top:8px}
  .notice{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted);font-size:13px;margin-top:8px}
  .table-wrap{max-height:520px;overflow:auto}
  .pill{background:var(--glass);padding:6px 8px;border-radius:999px;font-size:13px}
  .pill.danger{background:rgba(239,68,68,0.12);color:var(--danger)}
  .pill.success{background:rgba(16,185,129,0.08);color:var(--success)}
  .pill.warning{background:rgba(245,158,11,0.12);color:var(--warning)}
  .linklike{background:none;border:none;color:var(--accent);cursor:pointer;padding:0;font-size:13px;text-decoration:underline}
  .linklike:hover{opacity:0.7}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:4px;margin-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.06)}
  .tab{padding:10px 16px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all 0.2s}
  .tab:hover{color:#fff}
  .tab.active{color:#fff;border-bottom-color:var(--accent)}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .stat-card{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
  .stat-label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .stat-value{font-size:22px;font-weight:600}
  .employee-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04)}
  .employee-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:6px}
  .employee-name{font-weight:600;font-size:14px}
  .employee-info{font-size:12px;color:var(--muted);margin-top:2px}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:8px}
  .calendar-day{aspect-ratio:1;padding:4px;border-radius:4px;background:rgba(255,255,255,0.02);font-size:11px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:all 0.2s}
  .calendar-day:hover{background:rgba(255,255,255,0.05)}
  .calendar-day.today{border-color:var(--accent);background:rgba(59,130,246,0.1)}
  .calendar-day.has-data{background:rgba(16,185,129,0.1);border-color:var(--success)}
  .calendar-day.empty{cursor:default;background:transparent;border:none}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;padding:20px}
  .modal.active{display:flex}
  .modal-content{background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));border-radius:12px;padding:20px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;padding:0;width:auto}
  .badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
  .badge.active{background:rgba(16,185,129,0.2);color:var(--success)}
  .badge.inactive{background:rgba(239,68,68,0.2);color:var(--danger)}
  .badge.vacation{background:rgba(245,158,11,0.2);color:var(--warning)}
  .template-card{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:all 0.2s}
  .template-card:hover{background:rgba(255,255,255,0.04)}
  .template-card.selected{border-color:var(--accent);background:rgba(59,130,246,0.1)}
  .insight-card{background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);padding:10px;border-radius:8px;margin-top:8px}
  .progress-bar{height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;margin-top:6px}
  .progress-fill{height:100%;background:var(--accent);transition:width 0.3s}
  .category-bar{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;margin-bottom:6px}
  .category-name{font-size:13px;margin-bottom:4px}
  .category-amount{font-size:12px;color:var(--muted)}
  hr{margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)}
  canvas{max-height:250px}
  @media(max-width:768px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>Gigbridge Sistema de Gestión Financiera </h1>

</header>

<div class="layout">
  <aside class="card">
    <div class="tabs" style="flex-direction:column;border:none">
      <div class="tab active" data-section="balance">💰 Balance</div>
          <div class="tab" data-section="employees">👥 Empleados</div>
      <div class="tab" data-section="payroll">💳 Nómina</div>
      <div class="tab" data-section="recurring">🔄 Recurrentes</div>
      <div class="tab" data-section="import">📥 Import/Export</div>
    </div>

    <div id="section-balance" class="tab-content active">
     
      
      <div class="controls">
       
      </div>

      <hr>

      <h3>Agregar Movimiento</h3>
      <input id="txDate" type="date" />
      <input id="txDesc" type="text" placeholder="Descripción" />
      <div class="row">
        <select id="txType">
          <option value="Ingreso">Ingreso</option>
          <option value="Gasto">Gasto</option>
        </select>
        <input id="txAmount" type="number" step="0.01" placeholder="Monto" />
      </div>
      <div class="row">
        <input id="txCommPct" type="number" step="0.01" placeholder="Comisión (%)" />
        <input id="txCategory" type="text" placeholder="Categoría" />
      </div>
      <input id="txNotes" type="text" placeholder="Notas adicionales (opcional)" />
      <div class="controls">
        <button id="addTx" class="btn">Añadir</button>
        <button id="addTxSample" class="btn ghost">Ejemplo</button>
      </div>
    </div>

    <div id="section-employees" class="tab-content">
      <h3>Gestión de Empleados</h3>
      <button id="addEmployeeBtn" class="btn">+ Agregar Empleado</button>
      <div id="employeesList" style="margin-top:12px"></div>
    </div>

    <div id="section-payroll" class="tab-content">
      <h3>Plantillas de Nómina</h3>
      <button id="createTemplateBtn" class="btn">+ Nueva Plantilla</button>
      <div id="templatesList" style="margin-top:12px"></div>
      <hr>
      <button id="processPayrollBtn" class="btn success">💰 Procesar Nómina</button>
      <div class="notice">
        Las plantillas te permiten configurar pagos recurrentes de nómina con diferentes estructuras salariales.
      </div>
    </div>

    <div id="section-recurring" class="tab-content">
      <h3>Gastos/Ingresos Recurrentes</h3>
      <input id="recDesc" type="text" placeholder="Descripción" />
      <div class="row">
        <select id="recType">
          <option value="Gasto">Gasto</option>
          <option value="Ingreso">Ingreso</option>
        </select>
        <input id="recAmount" type="number" step="0.01" placeholder="Monto" />
      </div>
      <div class="row">
        <input id="recStart" type="date" />
        <select id="recFreq">
          <option value="monthly">Mensual</option>
          <option value="weekly">Semanal</option>
          <option value="daily">Diario</option>
        </select>
      </div>
      <div class="row">
        <input id="recEnd" type="date" placeholder="Fecha fin (opcional)" />
        <input id="recCommPct" type="number" step="0.01" placeholder="Comisión (%)" />
      </div>
      <div class="controls">
        <button id="addRec" class="btn small-btn">Crear</button>
        <button id="applyRecs" class="btn ghost small-btn">Aplicar ahora</button>
      </div>
      <hr>
      <div id="recurrentsList"></div>
    </div>

    <div id="section-import" class="tab-content">
      <h3>Import / Export</h3>
      <div class="controls">
        <button id="exportCSV" class="btn small-btn">Exportar CSV</button>
        <button id="importCSVbtn" class="btn ghost small-btn">Importar CSV</button>
      </div>
      <input id="importCSV" type="file" accept=".csv" style="display:none" />
      <hr>
      <div class="controls">
        <button id="exportJSON" class="btn small-btn">Backup JSON</button>
        <button id="importJSONbtn" class="btn ghost small-btn">Restaurar JSON</button>
      </div>
      <input id="importJSON" type="file" accept=".json" style="display:none" />
      <div class="notice">
        Exporta CSV para análisis en Excel. Usa JSON para backup completo del sistema.
      </div>
    </div>
  </aside>

  <main class="card">
    <div class="tabs">
      <div class="tab active" data-maintab="dashboard">📊 Dashboard</div>
      <div class="tab" data-maintab="ledger">📖 Libro Mayor</div>
      <div class="tab" data-maintab="calendar">📅 Calendario</div>
      <div class="tab" data-maintab="reports">📈 Reportes</div>
      <div class="tab" data-maintab="team">👔 Equipo</div>
    </div>

    <div id="maintab-dashboard" class="tab-content active">
      <div class="grid-3">
        <div class="stat-card">
          <div class="stat-label">Saldo Actual</div>
          <div class="stat-value" id="dashBalance">$0.00</div>
          <div class="stat-label" id="dashBalanceChange" style="margin-top:4px"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ingresos del Mes</div>
          <div class="stat-value positive" id="dashIncome">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Gastos del Mes</div>
          <div class="stat-value negative" id="dashExpenses">$0.00</div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="stat-card">
          <div class="stat-label">Empleados Activos</div>
          <div class="stat-value" id="dashEmployees">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Nómina Mensual</div>
          <div class="stat-value" id="dashPayroll">$0.00</div>
        </div>
      </div>

      <h3 style="margin-top:16px">Flujo de Caja - Últimos 7 Días</h3>
      <canvas id="weekChart"></canvas>

      <div class="insight-card">
        <strong>💡 Insight Financiero:</strong>
        <div id="insightText" style="margin-top:6px;color:var(--muted)">Configura tu saldo inicial para comenzar</div>
      </div>

      <h3 style="margin-top:16px">Actividad Reciente</h3>
      <div id="recentActivity"></div>
    </div>

    <div id="maintab-ledger" class="tab-content">
      <div class="flex-between">
        <h3>Libro Mayor / Movimientos</h3>
        <div>
          <select id="filterCategory" style="width:auto;padding:6px 10px">
            <option value="">Todas las categorías</option>
          </select>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:12px">
        <table id="ledger">
          <thead>
            <tr>
              <th>Fecha</th><th>Descripción</th><th>Tipo</th><th>Monto</th><th>Comisión</th><th>Categ.</th><th>Saldo</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="6"><strong>Balance Final</strong></td><td id="footerBalance">USD 0.00</td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="maintab-calendar" class="tab-content">
      <div class="calendar-header">
        <button id="prevMonth" class="btn ghost small-btn">◀ Anterior</button>
        <h3 id="calendarTitle">Mes Año</h3>
        <button id="nextMonth" class="btn ghost small-btn">Siguiente ▶</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
      <div id="calendarDetails" style="margin-top:16px"></div>
    </div>

    <div id="maintab-reports" class="tab-content">
      <h3>Análisis Financiero</h3>
      
      <h3 style="margin-top:16px">Ingresos vs Gastos - Últimos 30 Días</h3>
      <canvas id="monthChart"></canvas>

      <div class="grid-2" style="margin-top:16px">
        <div>
          <h3>Top Categorías de Gastos</h3>
          <div id="topExpenses"></div>
        </div>
        <div>
          <h3>Top Categorías de Ingresos</h3>
          <div id="topIncomes"></div>
        </div>
      </div>

      <h3 style="margin-top:16px">Proyección de Flujo</h3>
      <div class="stat-card">
        <div class="stat-label">Proyección 30 días</div>
        <div id="projectionText" style="margin-top:8px"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="projectionBar"></div>
        </div>
      </div>
    </div>

    <div id="maintab-team" class="tab-content">
      <h3>Equipo de Trabajo</h3>
      <div id="teamGrid"></div>
      
      <h3 style="margin-top:16px">Histórico de Nóminas</h3>
      <div id="payrollHistory"></div>
    </div>

    <footer>
      <div class="flex-between">
        <span>Sistema de Gestión Financiera v2.0 — Última actualización: <span id="lastUpdate">—</span></span>
        <button id="clearLocal" class="btn ghost small-btn">Limpiar datos</button>
      </div>
    </footer>
  </main>
</div>

<!-- Modal Empleado -->
<div id="employeeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="employeeModalTitle">Agregar Empleado</h2>
      <button class="modal-close" onclick="closeModal('employeeModal')">&times;</button>
    </div>
    <label>Nombre Completo</label>
    <input id="empName" type="text" placeholder="Juan Pérez" />
    <label>Puesto</label>
    <input id="empPosition" type="text" placeholder="Desarrollador Senior" />
    <label>Departamento</label>
    <input id="empDepartment" type="text" placeholder="Tecnología" />
    <div class="row">
      <div style="flex:1">
        <label>Salario Base (mensual)</label>
        <input id="empSalary" type="number" step="0.01" placeholder="3000" />
      </div>
      <div style="flex:1">
        <label>Fecha de Ingreso</label>
        <input id="empStartDate" type="date" />
      </div>
    </div>
    <label>Email</label>
    <input id="empEmail" type="email" placeholder="juan@empresa.com" />
    <label>Teléfono</label>
    <input id="empPhone" type="tel" placeholder="+506 8888-8888" />
    <label>Estado</label>
    <select id="empStatus">
      <option value="active">Activo</option>
      <option value="inactive">Inactivo</option>
      <option value="vacation">Vacaciones</option>
    </select>
    <label>Notas</label>
    <textarea id="empNotes" placeholder="Información adicional..."></textarea>
    <div class="controls" style="margin-top:12px">
      <button id="saveEmployee" class="btn">Guardar</button>
      <button class="btn ghost" onclick="closeModal('employeeModal')">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Plantilla Nómina -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Nueva Plantilla de Nómina</h2>
      <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
    </div>

    <label>Nombre de la Plantilla</label>
    <input id="tempName" type="text" placeholder="Nómina Mensual Estándar" />

    <label>Descripción</label>
    <textarea id="tempDesc" placeholder="Plantilla para pagos mensuales regulares..."></textarea>

    <label>Frecuencia de Pago</label>
    <select id="tempFreq">
      <option value="monthly">Mensual</option>
      <option value="biweekly">Quincenal</option>
      <option value="weekly">Semanal</option>
    </select>

    <label>Día de Pago</label>
    <input id="tempDay" type="number" min="1" max="31" placeholder="15" value="15" />

    <label>Bonificaciones (%)</label>
    <input id="tempBonus" type="number" step="0.01" placeholder="0" value="0" />

    <label>Deducciones (%)</label>
    <input id="tempDeductions" type="number" step="0.01" placeholder="0" value="0" />

    <hr>

    <h3>Empleados de la Plantilla</h3>
    <table id="payrollTable" border="1" style="width:100%; margin:12px 0; border-collapse:collapse; text-align:left;">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Salario</th>
          <th>Adelantos</th>
          <th>Salario Bruto</th>
          <th>Salario Neto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="controls">
      <button id="addRow" class="btn small-btn">+ Agregar Empleado</button>
    </div>

    <div class="notice">
      Esta plantilla se aplicará a todos los empleados activos según su salario base y ajustes.
    </div>

    <div class="controls" style="margin-top:12px">
      <button id="saveTemplate" class="btn">Guardar Plantilla</button>
      <button class="btn ghost" onclick="closeModal('templateModal')">Cancelar</button>
    </div>
  </div>
</div>


<!-- Modal Detalles del Día -->
<div id="dayModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="dayModalTitle">Detalles del Día</h2>
      <button class="modal-close" onclick="closeModal('dayModal')">&times;</button>
    </div>
    <div id="dayModalContent"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ==== VARIABLES DE ESTADO ====
  let data = JSON.parse(sessionStorage.getItem("finData")) || {
    initialBalance: 0,
    transactions: [],
    employees: [],
    templates: [],
    recurrents: []
  };

  // ==== GUARDAR ====
  const saveData = () => sessionStorage.setItem("finData", JSON.stringify(data));

  // ==== TABS ====
  document.querySelectorAll("aside .tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("aside .tab, aside .tab-content").forEach(el=>el.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById("section-"+tab.dataset.section).classList.add("active");
    });
  });
  document.querySelectorAll("main .tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("main .tab, main .tab-content").forEach(el=>el.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById("maintab-"+tab.dataset.maintab).classList.add("active");
    });
  });

  // ==== SALDO INICIAL ====
  const dashBalance = document.getElementById("dashBalance");
  const footerBalance = document.getElementById("footerBalance");
  const updateBalance = () => {
    let bal = data.initialBalance;
    data.transactions.forEach(t=>{
      let amt = parseFloat(t.amount);
      if(t.type==="Ingreso") bal += amt; else bal -= amt;
      if(t.commission) bal -= (amt*t.commission/100);
    });
    dashBalance.textContent = "$"+bal.toFixed(2);
    footerBalance.textContent = "USD "+bal.toFixed(2);
  };
  document.getElementById("setInitial").onclick = () => {
    data.initialBalance = parseFloat(document.getElementById("initialBalance").value)||0;
    saveData(); updateBalance();
  };
  document.getElementById("resetAll").onclick = () => {
    if(confirm("¿Seguro que deseas borrar todo?")){
      sessionStorage.clear(); location.reload();
    }
  };

  // ==== MOVIMIENTOS ====
  const ledgerBody = document.querySelector("#ledger tbody");
  const renderLedger = () => {
    ledgerBody.innerHTML="";
    let bal = data.initialBalance;
    data.transactions.forEach((t,i)=>{
      let amt = parseFloat(t.amount);
      if(t.type==="Ingreso") bal += amt; else bal -= amt;
      if(t.commission) bal -= (amt*t.commission/100);
      let row = `<tr>
        <td>${t.date}</td><td>${t.desc}</td><td>${t.type}</td>
        <td>${amt.toFixed(2)}</td><td>${t.commission||0}%</td>
        <td>${t.category||""}</td><td>${bal.toFixed(2)}</td>
        <td><button data-i="${i}" class="delTx">❌</button></td>
      </tr>`;
      ledgerBody.insertAdjacentHTML("beforeend",row);
    });
    updateBalance();
  };
  document.getElementById("addTx").onclick=()=>{
    let tx={
      date:document.getElementById("txDate").value||new Date().toISOString().slice(0,10),
      desc:document.getElementById("txDesc").value,
      type:document.getElementById("txType").value,
      amount:parseFloat(document.getElementById("txAmount").value)||0,
      commission:parseFloat(document.getElementById("txCommPct").value)||0,
      category:document.getElementById("txCategory").value,
      notes:document.getElementById("txNotes").value
    };
    data.transactions.push(tx); saveData(); renderLedger();
  };
  ledgerBody.addEventListener("click",(e)=>{
    if(e.target.classList.contains("delTx")){
      data.transactions.splice(e.target.dataset.i,1); saveData(); renderLedger();
    }
  });

  // ==== DASHBOARD INGRESOS/GASTOS ====
  const updateDashboard = () => {
    let income=0, expenses=0;
    data.transactions.forEach(t=>{
      if(t.type==="Ingreso") income+=parseFloat(t.amount);
      else expenses+=parseFloat(t.amount);
    });
    document.getElementById("dashIncome").textContent="$"+income.toFixed(2);
    document.getElementById("dashExpenses").textContent="$"+expenses.toFixed(2);
    document.getElementById("dashEmployees").textContent=data.employees.length;
    document.getElementById("dashPayroll").textContent="$"+(data.employees.length*1000).toFixed(2);
  };

  // ==== GRAFICOS ====
  const ctxWeek = document.getElementById("weekChart").getContext("2d");
  let weekChart = new Chart(ctxWeek,{type:"line",data:{labels:[],datasets:[{label:"Flujo",data:[],borderColor:"#38bdf8"}]}});
  const updateWeekChart=()=>{
    let last7= data.transactions.slice(-7);
    weekChart.data.labels=last7.map(t=>t.date);
    weekChart.data.datasets[0].data=last7.map(t=>t.type==="Ingreso"?t.amount:-t.amount);
    weekChart.update();
  };

  // ==== EXPORT/IMPORT ====
  document.getElementById("exportJSON").onclick=()=>{
    const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="backup.json"; a.click();
  };
  document.getElementById("importJSONbtn").onclick=()=>document.getElementById("importJSON").click();
  document.getElementById("importJSON").onchange=(e)=>{
    let fr=new FileReader();
    fr.onload=()=>{ data=JSON.parse(fr.result); saveData(); renderLedger(); updateDashboard(); updateWeekChart(); };
    fr.readAsText(e.target.files[0]);
  };
  document.getElementById("clearLocal").onclick=()=>{sessionStorage.clear(); location.reload();};

  // ==== INICIALIZAR ====
  renderLedger(); updateBalance(); updateDashboard(); updateWeekChart();
});










document.addEventListener("DOMContentLoaded", () => {
  // ==== VARIABLES DE ESTADO ====
  let data = JSON.parse(sessionStorage.getItem("finData")) || {
    initialBalance: 0,
    transactions: [],
    employees: [],
    templates: [],
    recurrents: []
  };

  // ==== GUARDAR ====
  const saveData = () => sessionStorage.setItem("finData", JSON.stringify(data));

  // ==== TABS ====
  document.querySelectorAll("aside .tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("aside .tab, aside .tab-content").forEach(el=>el.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById("section-"+tab.dataset.section).classList.add("active");
    });
  });
  document.querySelectorAll("main .tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll("main .tab, main .tab-content").forEach(el=>el.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById("maintab-"+tab.dataset.maintab).classList.add("active");
    });
  });

  // ==== SALDO INICIAL ====
  const dashBalance = document.getElementById("dashBalance");
  const footerBalance = document.getElementById("footerBalance");
  const updateBalance = () => {
    let bal = data.initialBalance;
    data.transactions.forEach(t=>{
      let amt = parseFloat(t.amount);
      if(t.type==="Ingreso") bal += amt; else bal -= amt;
      if(t.commission) bal -= (amt*t.commission/100);
    });
    dashBalance.textContent = "$"+bal.toFixed(2);
    footerBalance.textContent = "USD "+bal.toFixed(2);
  };
  document.getElementById("setInitial").onclick = () => {
    data.initialBalance = parseFloat(document.getElementById("initialBalance").value)||0;
    saveData(); updateBalance();
  };
  document.getElementById("resetAll").onclick = () => {
    if(confirm("¿Seguro que deseas borrar todo?")){
      sessionStorage.clear(); location.reload();
    }
  };

  // ==== MOVIMIENTOS ====
  const ledgerBody = document.querySelector("#ledger tbody");
  const renderLedger = () => {
    ledgerBody.innerHTML="";
    let bal = data.initialBalance;
    data.transactions.forEach((t,i)=>{
      let amt = parseFloat(t.amount);
      if(t.type==="Ingreso") bal += amt; else bal -= amt;
      if(t.commission) bal -= (amt*t.commission/100);
      let row = `<tr>
        <td>${t.date}</td><td>${t.desc}</td><td>${t.type}</td>
        <td>${amt.toFixed(2)}</td><td>${t.commission||0}%</td>
        <td>${t.category||""}</td><td>${bal.toFixed(2)}</td>
        <td><button data-i="${i}" class="delTx">❌</button></td>
      </tr>`;
      ledgerBody.insertAdjacentHTML("beforeend",row);
    });
    updateBalance();
  };
  document.getElementById("addTx").onclick=()=>{
    let tx={
      date:document.getElementById("txDate").value||new Date().toISOString().slice(0,10),
      desc:document.getElementById("txDesc").value,
      type:document.getElementById("txType").value,
      amount:parseFloat(document.getElementById("txAmount").value)||0,
      commission:parseFloat(document.getElementById("txCommPct").value)||0,
      category:document.getElementById("txCategory").value,
      notes:document.getElementById("txNotes").value
    };
    data.transactions.push(tx); saveData(); renderLedger();
  };
  ledgerBody.addEventListener("click",(e)=>{
    if(e.target.classList.contains("delTx")){
      data.transactions.splice(e.target.dataset.i,1); saveData(); renderLedger();
    }
  });

  // ==== DASHBOARD INGRESOS/GASTOS ====
  const updateDashboard = () => {
    let income=0, expenses=0;
    data.transactions.forEach(t=>{
      if(t.type==="Ingreso") income+=parseFloat(t.amount);
      else expenses+=parseFloat(t.amount);
    });
    document.getElementById("dashIncome").textContent="$"+income.toFixed(2);
    document.getElementById("dashExpenses").textContent="$"+expenses.toFixed(2);
    document.getElementById("dashEmployees").textContent=data.employees.length;
    document.getElementById("dashPayroll").textContent="$"+(data.employees.length*1000).toFixed(2);
  };

  // ==== GRAFICOS ====
  const ctxWeek = document.getElementById("weekChart").getContext("2d");
  let weekChart = new Chart(ctxWeek,{type:"line",data:{labels:[],datasets:[{label:"Flujo",data:[],borderColor:"#38bdf8"}]}});
  const updateWeekChart=()=>{
    let last7= data.transactions.slice(-7);
    weekChart.data.labels=last7.map(t=>t.date);
    weekChart.data.datasets[0].data=last7.map(t=>t.type==="Ingreso"?t.amount:-t.amount);
    weekChart.update();
  };

  // ==== EXPORT/IMPORT ====
  document.getElementById("exportJSON").onclick=()=>{
    const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="backup.json"; a.click();
  };
  document.getElementById("importJSONbtn").onclick=()=>document.getElementById("importJSON").click();
  document.getElementById("importJSON").onchange=(e)=>{
    let fr=new FileReader();
    fr.onload=()=>{ data=JSON.parse(fr.result); saveData(); renderLedger(); updateDashboard(); updateWeekChart(); };
    fr.readAsText(e.target.files[0]);
  };
  document.getElementById("clearLocal").onclick=()=>{sessionStorage.clear(); location.reload();};

  // ==== INICIALIZAR ====
  renderLedger(); updateBalance(); updateDashboard(); updateWeekChart();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "finData_v2";
  let data = JSON.parse(sessionStorage.getItem(STORAGE_KEY)) || {
    initialBalance: 0,
    transactions: [],
    employees: [],
    templates: [],
    recurrents: [],
    payrollHistory: [],
    lastUpdate: new Date().toISOString()
  };

  // Chart instances
  let weekChart = null;
  let monthChart = null;

  // Helpers
  const saveData = () => {
    data.lastUpdate = new Date().toISOString();
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    document.getElementById("lastUpdate").textContent = new Date(data.lastUpdate).toLocaleString();
  };
  // safe currency formatting (USD)
  const formatCurrency = (n) => {
    const num = Number(n) || 0;
    return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", minimumFractionDigits: 2 }).format(num);
  };
  const createId = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 5);

  // --- TAB HANDLING (aside and main) ---
  document.querySelectorAll("aside .tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll("aside .tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll("aside .tab-content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      const sec = document.getElementById("section-" + tab.dataset.section);
      if (sec) sec.classList.add("active");
    });
  });
  document.querySelectorAll("main .tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll("main .tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll("main .tab-content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      const sec = document.getElementById("maintab-" + tab.dataset.maintab);
      if (sec) sec.classList.add("active");
    });
  });

  // --- BALANCE / LEDGER ---
  const ledgerBody = document.querySelector("#ledger tbody");
  const footerBalanceEl = document.getElementById("footerBalance");
  const dashBalanceEl = document.getElementById("dashBalance");

  function calcRunningBalances(sortedTxs) {
    let bal = Number(data.initialBalance) || 0;
    const balances = [];
    for (const t of sortedTxs) {
      const amt = Number(t.amount) || 0;
      const comm = Number(t.commission) || 0;
      if (t.type === "Ingreso") {
        bal += amt;
      } else {
        bal -= amt;
      }
      // commission reduces net (applies regardless of type)
      bal -= (amt * comm / 100);
      balances.push(bal);
    }
    return balances;
  }

  function getCurrentBalance() {
    const sorted = [...data.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const balances = calcRunningBalances(sorted);
    return balances.length ? balances[balances.length - 1] : (Number(data.initialBalance) || 0);
  }

  function renderLedger(filterCategory = "") {
    ledgerBody.innerHTML = "";
    // sort oldest -> newest for running balance calculation
    const sorted = [...data.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
    const balances = calcRunningBalances(sorted);

    for (let i = 0; i < sorted.length; i++) {
      const t = sorted[i];
      if (filterCategory && (t.category || "") !== filterCategory) continue;
      const row = document.createElement("tr");
      const bal = balances[i];
      row.innerHTML = `
        <td>${t.date || ""}</td>
        <td>${(t.desc||"").replace(/</g,'&lt;')}</td>
        <td>${t.type || ""}</td>
        <td>${formatCurrency(Math.abs(Number(t.amount)||0))}</td>
        <td>${Number(t.commission||0)}%</td>
        <td>${t.category || ""}</td>
        <td>${formatCurrency(bal)}</td>
        <td>
          <button data-id="${t.id}" class="delTx">❌</button>
        </td>
      `;
      ledgerBody.appendChild(row);
    }
    footerBalanceEl.textContent = formatCurrency(getCurrentBalance());
    dashBalanceEl.textContent = formatCurrency(getCurrentBalance());
    populateCategoryFilter();
    renderRecentActivity();
  }

  ledgerBody.addEventListener("click", (e) => {
    if (e.target.classList.contains("delTx")) {
      const id = e.target.dataset.id;
      const idx = data.transactions.findIndex(x => x.id === id);
      if (idx !== -1) {
        if (confirm("Eliminar movimiento?")) {
          data.transactions.splice(idx, 1);
          saveData();
          refreshAll();
        }
      }
    }
  });

  // --- ADD TRANSACTION ---
  document.getElementById("addTx").addEventListener("click", () => {
    const tx = {
      id: createId(),
      date: document.getElementById("txDate").value || new Date().toISOString().slice(0, 10),
      desc: document.getElementById("txDesc").value || "",
      type: document.getElementById("txType").value || "Ingreso",
      amount: Number(document.getElementById("txAmount").value) || 0,
      commission: Number(document.getElementById("txCommPct").value) || 0,
      category: document.getElementById("txCategory").value || "",
      notes: document.getElementById("txNotes").value || ""
    };
    data.transactions.push(tx);
    saveData();
    refreshAll();
    // clear some inputs
    document.getElementById("txDesc").value = "";
    document.getElementById("txAmount").value = "";
    document.getElementById("txCommPct").value = "";
    document.getElementById("txCategory").value = "";
    document.getElementById("txNotes").value = "";
  });

  document.getElementById("addTxSample").addEventListener("click", () => {
    // agrega algunos movimientos de ejemplo
    const today = new Date();
    const sample = [
      { date: isoDaysAgo(0), desc: "Venta web", type: "Ingreso", amount: 1200, commission: 2, category: "Ventas" },
      { date: isoDaysAgo(1), desc: "Pago proveedor", type: "Gasto", amount: 450, commission: 0, category: "Proveedores" },
      { date: isoDaysAgo(2), desc: "Consultoría", type: "Ingreso", amount: 600, commission: 1.5, category: "Servicios" },
      { date: isoDaysAgo(3), desc: "Renta oficina", type: "Gasto", amount: 900, commission: 0, category: "Alquiler" },
      { date: isoDaysAgo(4), desc: "Factura cliente A", type: "Ingreso", amount: 250, commission: 0, category: "Ventas" }
    ];
    for (const s of sample) {
      data.transactions.push(Object.assign({ id: createId(), notes: "" }, s));
    }
    saveData();
    refreshAll();
  });

  function isoDaysAgo(days) {
    const d = new Date();
    d.setDate(d.getDate() - days);
    return d.toISOString().slice(0, 10);
  }

  // --- DASHBOARD METRICS ---
  function updateDashboard() {
    const income = data.transactions.reduce((acc, t) => acc + ((t.type === "Ingreso") ? Number(t.amount) : 0), 0);
    const expenses = data.transactions.reduce((acc, t) => acc + ((t.type === "Gasto") ? Number(t.amount) : 0), 0);
    const payrollEstimate = data.employees.reduce((acc, e) => acc + (Number(e.salary) || 0), 0);
    document.getElementById("dashIncome").textContent = formatCurrency(income);
    document.getElementById("dashExpenses").textContent = formatCurrency(expenses);
    document.getElementById("dashEmployees").textContent = data.employees.length;
    document.getElementById("dashPayroll").textContent = formatCurrency(payrollEstimate);
    updateTopCategories();
    updateProjection();
  }

  // --- CHARTS ---
  function updateWeekChart() {
    const ctx = document.getElementById("weekChart").getContext("2d");
    // last 7 days labels
    const labels = [];
    const values = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      labels.push(key);
      const dayNet = data.transactions
        .filter(t => t.date === key)
        .reduce((acc, t) => {
          const amt = Number(t.amount) || 0;
          const comm = Number(t.commission) || 0;
          const net = ((t.type === "Ingreso") ? amt : -amt) - (amt * comm / 100);
          return acc + net;
        }, 0);
      values.push(Number(dayNet.toFixed(2)));
    }
    if (weekChart) weekChart.destroy();
    weekChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{ label: "Flujo neto (últimos 7 días)", data: values, fill: false, borderColor: "rgba(56,189,248,1)", tension: 0.3 }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  function updateMonthChart() {
    const ctx = document.getElementById("monthChart").getContext("2d");
    const labels = [];
    const incomes = [];
    const expenses = [];
    for (let i = 29; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      labels.push(key);
      let dayIncome = 0, dayExpense = 0;
      data.transactions.filter(t => t.date === key).forEach(t => {
        const amt = Number(t.amount) || 0;
        if (t.type === "Ingreso") dayIncome += amt;
        else dayExpense += amt;
      });
      incomes.push(Number(dayIncome.toFixed(2)));
      expenses.push(Number(dayExpense.toFixed(2)));
    }
    if (monthChart) monthChart.destroy();
    monthChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Ingresos", data: incomes, backgroundColor: "rgba(34,197,94,0.7)" },
          { label: "Gastos", data: expenses, backgroundColor: "rgba(239,68,68,0.7)" }
        ]
      },
      options: { responsive: true, scales: { x: { stacked: false }, y: { beginAtZero: true } } }
    });
  }

  // --- Redirigir empleados a indes.html ---
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.dataset.section === "employees") {
      window.location.href = "indes.html"; // redirige directamente
    }
  });
});

  // --- TEMPLATES (simple) ---
  const templatesList = document.getElementById("templatesList");
  function renderTemplates() {
    templatesList.innerHTML = "";
    if (!data.templates.length) {
      templatesList.innerHTML = "<div style='color:var(--muted)'>Sin plantillas.</div>";
      return;
    }
    data.templates.forEach(tpl => {
      const div = document.createElement("div");
      div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.marginBottom = "8px";
      div.innerHTML = `<div><strong>${tpl.name}</strong><br><small>${tpl.items.length} ítems</small></div>
        <div>
          <button data-id="${tpl.id}" class="applyTpl btn small-btn">Aplicar</button>
          <button data-id="${tpl.id}" class="delTpl btn ghost small-btn">Eliminar</button>
        </div>`;
      templatesList.appendChild(div);
    });
  }
  document.getElementById("createTemplateBtn").addEventListener("click", () => {
    const name = prompt("Nombre de la plantilla:");
    if (!name) return;
    const raw = prompt("Define ítems como `Nombre:Monto` separados por comas.\nEjemplo: Juan:1200,Maria:900", "");
    const items = [];
    if (raw && raw.trim()) {
      raw.split(",").forEach(part => {
        const [nm, am] = part.split(":").map(s => s && s.trim());
        if (nm) items.push({ name: nm, amount: Number(am) || 0 });
      });
    }
    data.templates.push({ id: createId(), name, items });
    saveData(); renderTemplates();
  });
  templatesList.addEventListener("click", (e) => {
    if (e.target.classList.contains("delTpl")) {
      const id = e.target.dataset.id;
      const idx = data.templates.findIndex(x => x.id === id);
      if (idx !== -1 && confirm("Eliminar plantilla?")) {
        data.templates.splice(idx, 1);
        saveData(); renderTemplates();
      }
    } else if (e.target.classList.contains("applyTpl")) {
      const id = e.target.dataset.id;
      const tpl = data.templates.find(x => x.id === id);
      if (tpl && tpl.items.length) {
        if (confirm(`Aplicar plantilla "${tpl.name}"? Se crearán ${tpl.items.length} movimientos.`)) {
          const entries = [];
          for (const it of tpl.items) {
            const tx = {
              id: createId(),
              date: new Date().toISOString().slice(0, 10),
              desc: `Nómina - ${it.name}`,
              type: "Gasto",
              amount: Number(it.amount) || 0,
              commission: 0,
              category: "Nómina",
              notes: `Plantilla: ${tpl.name}`
            };
            data.transactions.push(tx);
            entries.push({ name: it.name, amount: tx.amount });
          }
          data.payrollHistory.push({ id: createId(), date: new Date().toISOString().slice(0, 10), total: entries.reduce((a,b) => a + Number(b.amount), 0), entries });
          saveData(); refreshAll();
        }
      } else alert("Plantilla vacía.");
    }
  });

  // Procesar nómina (suma salarios activos)
  document.getElementById("processPayrollBtn").addEventListener("click", () => {
    if (!data.employees.length) return alert("No hay empleados.");
    if (!confirm("Procesar nómina para TODOS los empleados (crea movimientos por cada empleado)?")) return;
    const today = new Date().toISOString().slice(0, 10);
    const entries = [];
    for (const emp of data.employees) {
      const amt = Number(emp.salary) || 0;
      const tx = {
        id: createId(),
        date: today,
        desc: `Nómina - ${emp.name}`,
        type: "Gasto",
        amount: amt,
        commission: 0,
        category: "Nómina",
        notes: "Procesada por usuario"
      };
      data.transactions.push(tx);
      entries.push({ employeeId: emp.id, name: emp.name, amount: amt });
    }
    data.payrollHistory.push({ id: createId(), date: today, total: entries.reduce((a,b)=>a+b.amount,0), entries });
    saveData(); refreshAll();
  });

  // --- RECURRENTES ---
  const recurrentsListEl = document.getElementById("recurrentsList");
  document.getElementById("addRec").addEventListener("click", () => {
    const rec = {
      id: createId(),
      desc: document.getElementById("recDesc").value || "",
      type: document.getElementById("recType").value || "Gasto",
      amount: Number(document.getElementById("recAmount").value) || 0,
      start: document.getElementById("recStart").value || new Date().toISOString().slice(0, 10),
      freq: document.getElementById("recFreq").value || "monthly",
      end: document.getElementById("recEnd").value || null,
      commission: Number(document.getElementById("recCommPct").value) || 0,
      lastApplied: null
    };
    data.recurrents.push(rec);
    saveData(); renderRecurrents();
    // clear inputs
    document.getElementById("recDesc").value = "";
    document.getElementById("recAmount").value = "";
  });

  document.getElementById("applyRecs").addEventListener("click", () => {
    applyAllRecurrentsNow();
  });

  function renderRecurrents() {
    recurrentsListEl.innerHTML = "";
    if (!data.recurrents.length) {
      recurrentsListEl.innerHTML = "<div style='color:var(--muted)'>No hay recurrentes.</div>";
      return;
    }
    data.recurrents.forEach(r => {
      const div = document.createElement("div");
      div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.marginBottom = "8px";
      div.innerHTML = `<div><strong>${r.desc}</strong><br><small>${r.type} • ${r.freq} • ${formatCurrency(r.amount)}</small></div>
        <div>
          <button data-id="${r.id}" class="applyRec btn small-btn">Aplicar ahora</button>
          <button data-id="${r.id}" class="delRec btn ghost small-btn">Eliminar</button>
        </div>`;
      recurrentsListEl.appendChild(div);
    });
  }

  recurrentsListEl.addEventListener("click", (e) => {
    if (e.target.classList.contains("delRec")) {
      const id = e.target.dataset.id;
      const idx = data.recurrents.findIndex(x => x.id === id);
      if (idx !== -1 && confirm("Eliminar recurrente?")) {
        data.recurrents.splice(idx, 1);
        saveData(); renderRecurrents();
      }
    } else if (e.target.classList.contains("applyRec")) {
      const id = e.target.dataset.id;
      const rec = data.recurrents.find(x => x.id === id);
      if (rec) {
        applyRecurrence(rec);
        saveData(); refreshAll();
      }
    }
  });

  function applyRecurrence(rec) {
    const tx = {
      id: createId(),
      date: new Date().toISOString().slice(0, 10),
      desc: rec.desc,
      type: rec.type,
      amount: Number(rec.amount) || 0,
      commission: Number(rec.commission) || 0,
      category: rec.category || "Recurrente",
      notes: `Recurrente (${rec.freq})`
    };
    data.transactions.push(tx);
    rec.lastApplied = new Date().toISOString().slice(0, 10);
  }
  function applyAllRecurrentsNow() {
    if (!data.recurrents.length) return alert("No hay recurrentes.");
    if (!confirm("Aplicar TODOS los recurrentes AHORA?")) return;
    for (const rec of data.recurrents) {
      applyRecurrence(rec);
    }
    saveData(); refreshAll();
  }

  // --- IMPORT / EXPORT JSON ---
  document.getElementById("exportJSON").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup_financiero.json";
    a.click();
  });
  document.getElementById("importJSONbtn").addEventListener("click", () => document.getElementById("importJSON").click());
  document.getElementById("importJSON").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const parsed = JSON.parse(fr.result);
        data = parsed;
        saveData(); refreshAll();
        alert("JSON importado correctamente.");
      } catch (err) { alert("JSON inválido."); }
    };
    fr.readAsText(f);
  });

  // --- CSV IMPORT / EXPORT ---
  document.getElementById("exportCSV").addEventListener("click", () => {
    // header
    const rows = [["date","desc","type","amount","commission","category","notes"]];
    for (const t of data.transactions) {
      rows.push([t.date || "", t.desc || "", t.type || "", (Number(t.amount)||0).toString(), (Number(t.commission)||0).toString(), t.category || "", t.notes || ""]);
    }
    const csv = rows.map(r => r.map(cell => {
      const s = (cell === null || cell === undefined) ? "" : String(cell);
      if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "movimientos.csv"; a.click();
  });

  document.getElementById("importCSVbtn").addEventListener("click", () => document.getElementById("importCSV").click());
  document.getElementById("importCSV").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const parsed = parseCSV(fr.result);
        // try to map common headers
        for (const row of parsed) {
          const lower = {};
          Object.keys(row).forEach(k => lower[k.toLowerCase().trim()] = row[k]);
          const tx = {
            id: createId(),
            date: row.date || row.fecha || lower.date || lower.fecha || new Date().toISOString().slice(0,10),
            desc: row.desc || row.descripcion || row.description || lower.desc || lower.descripcion || "",
            type: row.type || row.tipo || lower.type || lower.tipo || "Ingreso",
            amount: Number(row.amount || row.monto || lower.amount || lower.monto || 0) || 0,
            commission: Number(row.commission || row.comision || lower.commission || lower.comision || 0) || 0,
            category: row.category || row.categoria || lower.category || lower.categoria || "",
            notes: row.notes || row.notas || lower.notes || lower.notas || ""
          };
          data.transactions.push(tx);
        }
        saveData(); refreshAll(); alert("CSV importado.");
      } catch (err) { console.error(err); alert("Error al importar CSV."); }
    };
    fr.readAsText(f);
  });

  // simple CSV parser handling quotes
  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) return [];
    const headers = splitCSVLine(lines[0]).map(h => h.trim());
    const out = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = splitCSVLine(lines[i]);
      if (cols.length === 0) continue;
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j]] = cols[j] !== undefined ? cols[j] : "";
      }
      out.push(obj);
    }
    return out;
  }
  function splitCSVLine(line) {
    const res = [];
    let cur = "", inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes) {
        res.push(cur); cur = "";
      } else cur += ch;
    }
    res.push(cur);
    return res;
  }

  // --- FILTER BY CATEGORY ---
  function populateCategoryFilter() {
    const sel = document.getElementById("filterCategory");
    const existing = sel.value || "";
    const cats = new Set();
    for (const t of data.transactions) if (t.category) cats.add(t.category);
    // clear
    sel.innerHTML = "<option value=''>Todas las categorías</option>";
    Array.from(cats).sort().forEach(c => {
      const opt = document.createElement("option"); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    });
    sel.value = existing;
  }
  document.getElementById("filterCategory").addEventListener("change", (e) => {
    renderLedger(e.target.value);
  });

  // --- CALENDAR ---
  let calendarDate = new Date();
  function renderCalendar() {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    document.getElementById("calendarTitle").textContent = `${first.toLocaleString(undefined, { month: "long" })} ${year}`;
    const startWeekday = first.getDay(); // 0-6
    // fill blanks for first week
    for (let i = 0; i < startWeekday; i++) {
      const blank = document.createElement("div"); blank.innerHTML = ""; grid.appendChild(blank);
    }
    for (let d = 1; d <= last.getDate(); d++) {
      const dd = new Date(year, month, d);
      const key = dd.toISOString().slice(0, 10);
      const box = document.createElement("div");
      const txs = data.transactions.filter(t => t.date === key);
      box.innerHTML = `<div style="font-weight:600">${d}</div><div style="font-size:12px;color:var(--muted)">${txs.length} movimientos</div>`;
      box.style.cursor = "pointer";
      box.addEventListener("click", () => {
        const details = document.getElementById("calendarDetails");
        if (txs.length) {
          details.innerHTML = `<h4>Movimientos ${key}</h4>` + txs.map(t => `<div>${t.type} • ${formatCurrency(t.amount)} • ${t.desc}</div>`).join("");
        } else details.innerHTML = `<div style="color:var(--muted)">Sin movimientos para ${key}</div>`;
      });
      grid.appendChild(box);
    }
  }
  document.getElementById("prevMonth").addEventListener("click", () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
  document.getElementById("nextMonth").addEventListener("click", () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });

  // --- REPORTS: TOP CATEGORIES ---
  function updateTopCategories() {
    const last30 = getDatesAgo(30);
    const incomes = {}, expenses = {};
    for (const t of data.transactions) {
      if (!last30.includes(t.date)) continue;
      const cat = t.category || "Sin categoría";
      if (t.type === "Ingreso") incomes[cat] = (incomes[cat] || 0) + Number(t.amount || 0);
      else expenses[cat] = (expenses[cat] || 0) + Number(t.amount || 0);
    }
    function topList(obj) {
      return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([k,v]) => `<div>${k}: ${formatCurrency(v)}</div>`).join("") || "<div style='color:var(--muted)'>—</div>";
    }
    document.getElementById("topIncomes").innerHTML = topList(incomes);
    document.getElementById("topExpenses").innerHTML = topList(expenses);
  }
  function getDatesAgo(n) {
    const arr = [];
    for (let i = 0; i < n; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      arr.push(d.toISOString().slice(0, 10));
    }
    return arr;
  }

  // --- PROJECTION 30 DÍAS ---
  function updateProjection() {
    const last30Dates = new Set(getDatesAgo(30));
    let last30Net = 0;
    for (const t of data.transactions) {
      if (!last30Dates.has(t.date)) continue;
      const amt = Number(t.amount) || 0;
      const comm = Number(t.commission) || 0;
      const net = ((t.type === "Ingreso") ? amt : -amt) - (amt * comm / 100);
      last30Net += net;
    }
    const avgDaily = last30Net / 30;
    const current = getCurrentBalance();
    const projection = current + avgDaily * 30;
    const diff = projection - current;
    const projectionText = document.getElementById("projectionText");
    projectionText.textContent = `Saldo actual ${formatCurrency(current)} → Proyección 30 días ${formatCurrency(projection)} (Δ ${formatCurrency(diff)})`;

    const bar = document.getElementById("projectionBar");
    // percent mapping: if current non-zero, percent = clamp(50 + (diff/current)*50, 0, 100)
    let pct = 50;
    if (Math.abs(current) >= 1e-6) {
      pct = 50 + (diff / current) * 50;
    } else {
      pct = diff >= 0 ? 75 : 25;
    }
    pct = Math.max(0, Math.min(100, pct));
    bar.style.width = pct + "%";
  }

  // --- RECENT ACTIVITY ---
  function renderRecentActivity() {
    const area = document.getElementById("recentActivity");
    area.innerHTML = "";
    const sorted = [...data.transactions].sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0,10);
    if (!sorted.length) { area.innerHTML = "<div style='color:var(--muted)'>Sin actividad reciente.</div>"; return; }
    for (const t of sorted) {
      const div = document.createElement("div");
      div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.padding = "6px 0";
      div.innerHTML = `<div><strong>${t.desc}</strong><div style="font-size:12px;color:var(--muted)">${t.date} • ${t.category||""}</div></div>
        <div style="text-align:right">${t.type === "Ingreso" ? "+" : "-"} ${formatCurrency(t.amount)}</div>`;
      area.appendChild(div);
    }
  }

  // --- PAYROLL HISTORY & TEAM GRID ---
  function renderPayrollHistory() {
    const ph = document.getElementById("payrollHistory");
    ph.innerHTML = "";
    if (!data.payrollHistory.length) { ph.innerHTML = "<div style='color:var(--muted)'>No hay histórico de nóminas.</div>"; return; }
    for (const p of [...data.payrollHistory].reverse()) {
      const div = document.createElement("div");
      div.style.padding = "6px"; div.style.borderBottom = "1px solid rgba(255,255,255,0.03)";
      div.innerHTML = `<strong>${p.date}</strong> • Total: ${formatCurrency(p.total)} <div style="font-size:12px;color:var(--muted)">${p.entries.map(e=>`${e.name}: ${formatCurrency(e.amount)}`).join(" • ")}</div>`;
      ph.appendChild(div);
    }
  }

  function renderTeamGrid() {
    const tg = document.getElementById("teamGrid");
    tg.innerHTML = "";
    if (!data.employees.length) { tg.innerHTML = "<div style='color:var(--muted)'>Equipo vacío.</div>"; return; }
    for (const e of data.employees) {
      const card = document.createElement("div");
      card.style.padding = "8px"; card.style.borderBottom = "1px solid rgba(255,255,255,0.03)";
      card.innerHTML = `<strong>${e.name}</strong> • ${e.role || ""} • ${formatCurrency(e.salary||0)}`;
      tg.appendChild(card);
    }
  }

  // --- RECARGA / INICIALIZACIÓN GENERAL ---
  function refreshAll() {
    renderLedger(document.getElementById("filterCategory").value || "");
    updateDashboard();
    updateWeekChart();
    updateMonthChart();
    renderEmployees();
    renderTemplates();
    renderRecurrents();
    renderCalendar();
    updateTopCategories();
    updateProjection();
    renderRecentActivity();
    renderPayrollHistory();
    renderTeamGrid();
    saveData();
  }

  // initialize UI values
  document.getElementById("initialBalance").value = Number(data.initialBalance) || "";
  document.getElementById("lastUpdate").textContent = new Date(data.lastUpdate).toLocaleString();

  // clear local/session
  document.getElementById("clearLocal").addEventListener("click", () => {
    if (!confirm("Limpiar datos de sesión (se perderá todo)?")) return;
    sessionStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  // initial render
  refreshAll();

  // small convenience: if no transactions, create some sample so charts show
  // (comment out if undesired)
  // if (!data.transactions.length) { document.getElementById("addTxSample").click(); }

});


</script>
  
</body>
</html>
